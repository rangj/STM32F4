/*
 * SR2D1_0V3_MCU_S1 -- Service robot 2In1 servo driver
 * (C)2016 Kinco Electric (Shenzhen) Ltd. -- All rights reserved
 */
#include "includes.h"

const INT16S SinTable[SINE_TABLE_NUM]=
{
    0,50,101,151,201,251,302,352,402,452,503,553,603,653,704,754,804,854,904,955,1005,1055,1105,1155,1205,1255,1306,1356,1406,1456,1506,
    1556,1606,1656,1706,1756,1806,1856,1906,1956,2006,2055,2105,2155,2205,2255,2305,2354,2404,2454,2503,2553,2603,2652,2702,2752,2801,
    2851,2900,2949,2999,3048,3098,3147,3196,3246,3295,3344,3393,3442,3492,3541,3590,3639,3688,3737,3786,3835,3883,3932,3981,4030,4078,
    4127,4176,4224,4273,4321,4370,4418,4467,4515,4563,4612,4660,4708,4756,4804,4852,4900,4948,4996,5044,5092,5139,5187,5235,5282,5330,
    5377,5425,5472,5520,5567,5614,5661,5708,5756,5803,5850,5897,5943,5990,6037,6084,6130,6177,6223,6270,6316,6363,6409,6455,6501,6547,
    6593,6639,6685,6731,6777,6823,6868,6914,6960,7005,7050,7096,7141,7186,7231,7276,7321,7366,7411,7456,7501,7545,7590,7635,7679,7723,
    7768,7812,7856,7900,7944,7988,8032,8076,8119,8163,8207,8250,8293,8337,8380,8423,8466,8509,8552,8595,8638,8680,8723,8765,8808,8850,
    8892,8935,8977,9019,9061,9102,9144,9186,9227,9269,9310,9352,9393,9434,9475,9516,9557,9598,9638,9679,9720,9760,9800,9841,9881,9921,
    9961,10001,10040,10080,10120,10159,10198,10238,10277,10316,10355,10394,10433,10471,10510,10549,10587,10625,10663,10702,10740,10778,
    10815,10853,10891,10928,10966,11003,11040,11077,11114,11151,11188,11224,11261,11297,11334,11370,11406,11442,11478,11514,11550,11585,
    11621,11656,11691,11727,11762,11797,11831,11866,11901,11935,11970,12004,12038,12072,12106,12140,12173,12207,12240,12274,12307,12340,
    12373,12406,12439,12472,12504,12537,12569,12601,12633,12665,12697,12729,12760,12792,12823,12854,12885,12916,12947,12978,13008,13039,
    13069,13100,13130,13160,13190,13219,13249,13279,13308,13337,13366,13395,13424,13453,13482,13510,13538,13567,13595,13623,13651,13678,
    13706,13733,13761,13788,13815,13842,13869,13896,13922,13949,13975,14001,14027,14053,14079,14104,14130,14155,14181,14206,14231,14256,
    14280,14305,14329,14354,14378,14402,14426,14449,14473,14497,14520,14543,14566,14589,14612,14635,14657,14680,14702,14724,14746,14768,
    14789,14811,14832,14854,14875,14896,14917,14937,14958,14978,14999,15019,15039,15059,15078,15098,15118,15137,15156,15175,15194,15213,
    15231,15250,15268,15286,15304,15322,15340,15357,15375,15392,15409,15426,15443,15460,15476,15493,15509,15525,15541,15557,15573,15588,
    15604,15619,15634,15649,15664,15679,15693,15707,15722,15736,15750,15763,15777,15791,15804,15817,15830,15843,15856,15868,15881,15893,
    15905,15917,15929,15941,15952,15964,15975,15986,15997,16008,16018,16029,16039,16049,16059,16069,16079,16088,16098,16107,16116,16125,
    16134,16143,16151,16160,16168,16176,16184,16192,16199,16207,16214,16221,16228,16235,16242,16248,16255,16261,16267,16273,16279,16284,
    16290,16295,16300,16305,16310,16315,16319,16324,16328,16332,16336,16340,16343,16347,16350,16353,16356,16359,16362,16364,16367,16369,
    16371,16373,16375,16376,16378,16379,16380,16381,16382,16383,16383,16384,16384,16384,16384,16384,16383,16383,16382,16381,16380,16379,
    16378,16376,16375,16373,16371,16369,16367,16364,16362,16359,16356,16353,16350,16347,16343,16340,16336,16332,16328,16324,16319,16315,
    16310,16305,16300,16295,16290,16284,16279,16273,16267,16261,16255,16248,16242,16235,16228,16221,16214,16207,16199,16192,16184,16176,
    16168,16160,16151,16143,16134,16125,16116,16107,16098,16088,16079,16069,16059,16049,16039,16029,16018,16008,15997,15986,15975,15964,
    15952,15941,15929,15917,15905,15893,15881,15868,15856,15843,15830,15817,15804,15791,15777,15763,15750,15736,15722,15707,15693,15679,
    15664,15649,15634,15619,15604,15588,15573,15557,15541,15525,15509,15493,15476,15460,15443,15426,15409,15392,15375,15357,15340,15322,
    15304,15286,15268,15250,15231,15213,15194,15175,15156,15137,15118,15098,15078,15059,15039,15019,14999,14978,14958,14937,14917,14896,
    14875,14854,14832,14811,14789,14768,14746,14724,14702,14680,14657,14635,14612,14589,14566,14543,14520,14497,14473,14449,14426,14402,
    14378,14354,14329,14305,14280,14256,14231,14206,14181,14155,14130,14104,14079,14053,14027,14001,13975,13949,13922,13896,13869,13842,
    13815,13788,13761,13733,13706,13678,13651,13623,13595,13567,13538,13510,13482,13453,13424,13395,13366,13337,13308,13279,13249,13219,
    13190,13160,13130,13100,13069,13039,13008,12978,12947,12916,12885,12854,12823,12792,12760,12729,12697,12665,12633,12601,12569,12537,
    12504,12472,12439,12406,12373,12340,12307,12274,12240,12207,12173,12140,12106,12072,12038,12004,11970,11935,11901,11866,11831,11797,
    11762,11727,11691,11656,11621,11585,11550,11514,11478,11442,11406,11370,11334,11297,11261,11224,11188,11151,11114,11077,11040,11003,
    10966,10928,10891,10853,10815,10778,10740,10702,10663,10625,10587,10549,10510,10471,10433,10394,10355,10316,10277,10238,10198,10159,
    10120,10080,10040,10001,9961,9921,9881,9841,9800,9760,9720,9679,9638,9598,9557,9516,9475,9434,9393,9352,9310,9269,9227,9186,9144,
    9102,9061,9019,8977,8935,8892,8850,8808,8765,8723,8680,8638,8595,8552,8509,8466,8423,8380,8337,8293,8250,8207,8163,8119,8076,8032,
    7988,7944,7900,7856,7812,7768,7723,7679,7635,7590,7545,7501,7456,7411,7366,7321,7276,7231,7186,7141,7096,7050,7005,6960,6914,6868,
    6823,6777,6731,6685,6639,6593,6547,6501,6455,6409,6363,6316,6270,6223,6177,6130,6084,6037,5990,5943,5897,5850,5803,5756,5708,5661,
    5614,5567,5520,5472,5425,5377,5330,5282,5235,5187,5139,5092,5044,4996,4948,4900,4852,4804,4756,4708,4660,4612,4563,4515,4467,4418,
    4370,4321,4273,4224,4176,4127,4078,4030,3981,3932,3883,3835,3786,3737,3688,3639,3590,3541,3492,3442,3393,3344,3295,3246,3196,3147,
    3098,3048,2999,2949,2900,2851,2801,2752,2702,2652,2603,2553,2503,2454,2404,2354,2305,2255,2205,2155,2105,2055,2006,1956,1906,1856,
    1806,1756,1706,1656,1606,1556,1506,1456,1406,1356,1306,1255,1205,1155,1105,1055,1005,955,904,854,804,754,704,653,603,553,503,452,
    402,352,302,251,201,151,101,50,0,-50,-101,-151,-201,-251,-302,-352,-402,-452,-503,-553,-603,-653,-704,-754,-804,-854,-904,-955,-1005,
    -1055,-1105,-1155,-1205,-1255,-1306,-1356,-1406,-1456,-1506,-1556,-1606,-1656,-1706,-1756,-1806,-1856,-1906,-1956,-2006,-2055,-2105,
    -2155,-2205,-2255,-2305,-2354,-2404,-2454,-2503,-2553,-2603,-2652,-2702,-2752,-2801,-2851,-2900,-2949,-2999,-3048,-3098,-3147,-3196,
    -3246,-3295,-3344,-3393,-3442,-3492,-3541,-3590,-3639,-3688,-3737,-3786,-3835,-3883,-3932,-3981,-4030,-4078,-4127,-4176,-4224,-4273,
    -4321,-4370,-4418,-4467,-4515,-4563,-4612,-4660,-4708,-4756,-4804,-4852,-4900,-4948,-4996,-5044,-5092,-5139,-5187,-5235,-5282,-5330,
    -5377,-5425,-5472,-5520,-5567,-5614,-5661,-5708,-5756,-5803,-5850,-5897,-5943,-5990,-6037,-6084,-6130,-6177,-6223,-6270,-6316,-6363,
    -6409,-6455,-6501,-6547,-6593,-6639,-6685,-6731,-6777,-6823,-6868,-6914,-6960,-7005,-7050,-7096,-7141,-7186,-7231,-7276,-7321,-7366,
    -7411,-7456,-7501,-7545,-7590,-7635,-7679,-7723,-7768,-7812,-7856,-7900,-7944,-7988,-8032,-8076,-8119,-8163,-8207,-8250,-8293,-8337,
    -8380,-8423,-8466,-8509,-8552,-8595,-8638,-8680,-8723,-8765,-8808,-8850,-8892,-8935,-8977,-9019,-9061,-9102,-9144,-9186,-9227,-9269,
    -9310,-9352,-9393,-9434,-9475,-9516,-9557,-9598,-9638,-9679,-9720,-9760,-9800,-9841,-9881,-9921,-9961,-10001,-10040,-10080,-10120,-10159,
    -10198,-10238,-10277,-10316,-10355,-10394,-10433,-10471,-10510,-10549,-10587,-10625,-10663,-10702,-10740,-10778,-10815,-10853,-10891,-10928,
    -10966,-11003,-11040,-11077,-11114,-11151,-11188,-11224,-11261,-11297,-11334,-11370,-11406,-11442,-11478,-11514,-11550,-11585,-11621,-11656,
    -11691,-11727,-11762,-11797,-11831,-11866,-11901,-11935,-11970,-12004,-12038,-12072,-12106,-12140,-12173,-12207,-12240,-12274,-12307,-12340,
    -12373,-12406,-12439,-12472,-12504,-12537,-12569,-12601,-12633,-12665,-12697,-12729,-12760,-12792,-12823,-12854,-12885,-12916,-12947,-12978,
    -13008,-13039,-13069,-13100,-13130,-13160,-13190,-13219,-13249,-13279,-13308,-13337,-13366,-13395,-13424,-13453,-13482,-13510,-13538,-13567,
    -13595,-13623,-13651,-13678,-13706,-13733,-13761,-13788,-13815,-13842,-13869,-13896,-13922,-13949,-13975,-14001,-14027,-14053,-14079,-14104,
    -14130,-14155,-14181,-14206,-14231,-14256,-14280,-14305,-14329,-14354,-14378,-14402,-14426,-14449,-14473,-14497,-14520,-14543,-14566,-14589,
    -14612,-14635,-14657,-14680,-14702,-14724,-14746,-14768,-14789,-14811,-14832,-14854,-14875,-14896,-14917,-14937,-14958,-14978,-14999,-15019,
    -15039,-15059,-15078,-15098,-15118,-15137,-15156,-15175,-15194,-15213,-15231,-15250,-15268,-15286,-15304,-15322,-15340,-15357,-15375,-15392,
    -15409,-15426,-15443,-15460,-15476,-15493,-15509,-15525,-15541,-15557,-15573,-15588,-15604,-15619,-15634,-15649,-15664,-15679,-15693,-15707,
    -15722,-15736,-15750,-15763,-15777,-15791,-15804,-15817,-15830,-15843,-15856,-15868,-15881,-15893,-15905,-15917,-15929,-15941,-15952,-15964,
    -15975,-15986,-15997,-16008,-16018,-16029,-16039,-16049,-16059,-16069,-16079,-16088,-16098,-16107,-16116,-16125,-16134,-16143,-16151,-16160,
    -16168,-16176,-16184,-16192,-16199,-16207,-16214,-16221,-16228,-16235,-16242,-16248,-16255,-16261,-16267,-16273,-16279,-16284, -16290,-16295,
    -16300,-16305,-16310,-16315,-16319,-16324,-16328,-16332,-16336,-16340,-16343,-16347,-16350,-16353,-16356,-16359,-16362,-16364,-16367,-16369,
    -16371,-16373,-16375,-16376,-16378,-16379,-16380,-16381,-16382,-16383,-16383,-16384,-16384,-16384,-16384,-16384,-16383,-16383,-16382,-16381,
    -16380,-16379,-16378,-16376,-16375,-16373,-16371,-16369,-16367,-16364,-16362,-16359,-16356,-16353,-16350,-16347,-16343,-16340,-16336,-16332,
    -16328,-16324,-16319,-16315,-16310,-16305,-16300,-16295,-16290,-16284,-16279,-16273,-16267,-16261,-16255,-16248,-16242,-16235,-16228,-16221,
    -16214,-16207,-16199,-16192,-16184,-16176,-16168,-16160,-16151,-16143,-16134,-16125,-16116,-16107,-16098,-16088,-16079,-16069,-16059,-16049,
    -16039,-16029,-16018,-16008,-15997,-15986,-15975,-15964,-15952,-15941,-15929,-15917,-15905,-15893,-15881,-15868,-15856,-15843,-15830,-15817,
    -15804,-15791,-15777,-15763,-15750,-15736,-15722,-15707,-15693,-15679,-15664,-15649,-15634,-15619,-15604,-15588,-15573,-15557,-15541,-15525,
    -15509,-15493,-15476,-15460,-15443,-15426,-15409,-15392,-15375,-15357,-15340,-15322,-15304,-15286,-15268,-15250,-15231,-15213,-15194,-15175,
    -15156,-15137,-15118,-15098,-15078,-15059,-15039,-15019,-14999,-14978,-14958,-14937,-14917,-14896,-14875,-14854,-14832,-14811,-14789,-14768,
    -14746,-14724,-14702,-14680,-14657,-14635,-14612,-14589,-14566,-14543,-14520,-14497,-14473,-14449,-14426,-14402,-14378,-14354,-14329,-14305,
    -14280,-14256,-14231,-14206,-14181,-14155,-14130,-14104,-14079,-14053,-14027,-14001,-13975,-13949,-13922,-13896,-13869,-13842,-13815,-13788,
    -13761,-13733,-13706,-13678,-13651,-13623,-13595,-13567,-13538,-13510,-13482,-13453,-13424,-13395,-13366,-13337,-13308,-13279,-13249,-13219,
    -13190,-13160,-13130,-13100,-13069,-13039,-13008,-12978,-12947,-12916,-12885,-12854,-12823,-12792,-12760,-12729,-12697,-12665,-12633,-12601,
    -12569,-12537,-12504,-12472,-12439,-12406,-12373,-12340,-12307,-12274,-12240,-12207,-12173,-12140,-12106,-12072,-12038,-12004,-11970,-11935,
    -11901,-11866,-11831,-11797,-11762,-11727,-11691,-11656,-11621,-11585,-11550,-11514,-11478,-11442,-11406,-11370,-11334,-11297,-11261,-11224,
    -11188,-11151,-11114,-11077,-11040,-11003,-10966,-10928,-10891,-10853,-10815,-10778,-10740,-10702,-10663,-10625,-10587,-10549,-10510,-10471,
    -10433,-10394,-10355,-10316,-10277,-10238,-10198,-10159,-10120,-10080,-10040,-10001,-9961,-9921,-9881,-9841,-9800,-9760,-9720,-9679,-9638,
    -9598,-9557,-9516,-9475,-9434,-9393,-9352,-9310,-9269,-9227,-9186,-9144,-9102,-9061,-9019,-8977,-8935,-8892,-8850,-8808,-8765,-8723,-8680,
    -8638,-8595,-8552,-8509,-8466,-8423,-8380,-8337,-8293,-8250,-8207,-8163,-8119,-8076,-8032,-7988,-7944,-7900,-7856,-7812,-7768,-7723,-7679,
    -7635,-7590,-7545,-7501,-7456,-7411,-7366,-7321,-7276,-7231,-7186,-7141,-7096,-7050,-7005,-6960,-6914,-6868,-6823,-6777,-6731,-6685,-6639,
    -6593,-6547,-6501,-6455,-6409,-6363,-6316,-6270,-6223,-6177,-6130,-6084,-6037,-5990,-5943,-5897,-5850,-5803,-5756,-5708,-5661,-5614,-5567,
    -5520,-5472,-5425,-5377,-5330,-5282,-5235,-5187,-5139,-5092,-5044,-4996,-4948,-4900,-4852,-4804,-4756,-4708,-4660,-4612,-4563,-4515,-4467,
    -4418,-4370,-4321,-4273,-4224,-4176,-4127,-4078,-4030,-3981,-3932,-3883,-3835,-3786,-3737,-3688,-3639,-3590,-3541,-3492,-3442,-3393,-3344,
    -3295,-3246,-3196,-3147,-3098,-3048,-2999,-2949,-2900,-2851,-2801,-2752,-2702,-2652,-2603,-2553,-2503,-2454,-2404,-2354,-2305,-2255,-2205,
    -2155,-2105,-2055,-2006,-1956,-1906,-1856,-1806,-1756,-1706,-1656,-1606,-1556,-1506,-1456,-1406,-1356,-1306,-1255,-1205,-1155,-1105,-1055,
    -1005,-955,-904,-854,-804,-754,-704,-653,-603,-553,-503,-452,-402,-352,-302,-251,-201,-151,-101,-50
};

const INT16S CosTable[COSINE_TABLE_NUM]=
{
    16384,16384,16384,16384,16384,16383,16383,16382,16381,16380,16379,
    16378,16376,16375,16373,16371,16369,16367,16364,16362,16359,16356,16353,16350,16347,16343,16340,16336,16332,16328,16324,16319,16315,
    16310,16305,16300,16295,16290,16284,16279,16273,16267,16261,16255,16248,16242,16235,16228,16221,16214,16207,16199,16192,16184,16176,
    16168,16160,16151,16143,16134,16125,16116,16107,16098,16088,16079,16069,16059,16049,16039,16029,16018,16008,15997,15986,15975,15964,
    15952,15941,15929,15917,15905,15893,15881,15868,15856,15843,15830,15817,15804,15791,15777,15763,15750,15736,15722,15707,15693,15679,
    15664,15649,15634,15619,15604,15588,15573,15557,15541,15525,15509,15493,15476,15460,15443,15426,15409,15392,15375,15357,15340,15322,
    15304,15286,15268,15250,15231,15213,15194,15175,15156,15137,15118,15098,15078,15059,15039,15019,14999,14978,14958,14937,14917,14896,
    14875,14854,14832,14811,14789,14768,14746,14724,14702,14680,14657,14635,14612,14589,14566,14543,14520,14497,14473,14449,14426,14402,
    14378,14354,14329,14305,14280,14256,14231,14206,14181,14155,14130,14104,14079,14053,14027,14001,13975,13949,13922,13896,13869,13842,
    13815,13788,13761,13733,13706,13678,13651,13623,13595,13567,13538,13510,13482,13453,13424,13395,13366,13337,13308,13279,13249,13219,
    13190,13160,13130,13100,13069,13039,13008,12978,12947,12916,12885,12854,12823,12792,12760,12729,12697,12665,12633,12601,12569,12537,
    12504,12472,12439,12406,12373,12340,12307,12274,12240,12207,12173,12140,12106,12072,12038,12004,11970,11935,11901,11866,11831,11797,
    11762,11727,11691,11656,11621,11585,11550,11514,11478,11442,11406,11370,11334,11297,11261,11224,11188,11151,11114,11077,11040,11003,
    10966,10928,10891,10853,10815,10778,10740,10702,10663,10625,10587,10549,10510,10471,10433,10394,10355,10316,10277,10238,10198,10159,
    10120,10080,10040,10001,9961,9921,9881,9841,9800,9760,9720,9679,9638,9598,9557,9516,9475,9434,9393,9352,9310,9269,9227,9186,9144,
    9102,9061,9019,8977,8935,8892,8850,8808,8765,8723,8680,8638,8595,8552,8509,8466,8423,8380,8337,8293,8250,8207,8163,8119,8076,8032,
    7988,7944,7900,7856,7812,7768,7723,7679,7635,7590,7545,7501,7456,7411,7366,7321,7276,7231,7186,7141,7096,7050,7005,6960,6914,6868,
    6823,6777,6731,6685,6639,6593,6547,6501,6455,6409,6363,6316,6270,6223,6177,6130,6084,6037,5990,5943,5897,5850,5803,5756,5708,5661,
    5614,5567,5520,5472,5425,5377,5330,5282,5235,5187,5139,5092,5044,4996,4948,4900,4852,4804,4756,4708,4660,4612,4563,4515,4467,4418,
    4370,4321,4273,4224,4176,4127,4078,4030,3981,3932,3883,3835,3786,3737,3688,3639,3590,3541,3492,3442,3393,3344,3295,3246,3196,3147,
    3098,3048,2999,2949,2900,2851,2801,2752,2702,2652,2603,2553,2503,2454,2404,2354,2305,2255,2205,2155,2105,2055,2006,1956,1906,1856,
    1806,1756,1706,1656,1606,1556,1506,1456,1406,1356,1306,1255,1205,1155,1105,1055,1005,955,904,854,804,754,704,653,603,553,503,452,
    402,352,302,251,201,151,101,50,0,-50,-101,-151,-201,-251,-302,-352,-402,-452,-503,-553,-603,-653,-704,-754,-804,-854,-904,-955,-1005,
    -1055,-1105,-1155,-1205,-1255,-1306,-1356,-1406,-1456,-1506,-1556,-1606,-1656,-1706,-1756,-1806,-1856,-1906,-1956,-2006,-2055,-2105,
    -2155,-2205,-2255,-2305,-2354,-2404,-2454,-2503,-2553,-2603,-2652,-2702,-2752,-2801,-2851,-2900,-2949,-2999,-3048,-3098,-3147,-3196,
    -3246,-3295,-3344,-3393,-3442,-3492,-3541,-3590,-3639,-3688,-3737,-3786,-3835,-3883,-3932,-3981,-4030,-4078,-4127,-4176,-4224,-4273,
    -4321,-4370,-4418,-4467,-4515,-4563,-4612,-4660,-4708,-4756,-4804,-4852,-4900,-4948,-4996,-5044,-5092,-5139,-5187,-5235,-5282,-5330,
    -5377,-5425,-5472,-5520,-5567,-5614,-5661,-5708,-5756,-5803,-5850,-5897,-5943,-5990,-6037,-6084,-6130,-6177,-6223,-6270,-6316,-6363,
    -6409,-6455,-6501,-6547,-6593,-6639,-6685,-6731,-6777,-6823,-6868,-6914,-6960,-7005,-7050,-7096,-7141,-7186,-7231,-7276,-7321,-7366,
    -7411,-7456,-7501,-7545,-7590,-7635,-7679,-7723,-7768,-7812,-7856,-7900,-7944,-7988,-8032,-8076,-8119,-8163,-8207,-8250,-8293,-8337,
    -8380,-8423,-8466,-8509,-8552,-8595,-8638,-8680,-8723,-8765,-8808,-8850,-8892,-8935,-8977,-9019,-9061,-9102,-9144,-9186,-9227,-9269,
    -9310,-9352,-9393,-9434,-9475,-9516,-9557,-9598,-9638,-9679,-9720,-9760,-9800,-9841,-9881,-9921,-9961,-10001,-10040,-10080,-10120,-10159,
    -10198,-10238,-10277,-10316,-10355,-10394,-10433,-10471,-10510,-10549,-10587,-10625,-10663,-10702,-10740,-10778,-10815,-10853,-10891,-10928,
    -10966,-11003,-11040,-11077,-11114,-11151,-11188,-11224,-11261,-11297,-11334,-11370,-11406,-11442,-11478,-11514,-11550,-11585,-11621,-11656,
    -11691,-11727,-11762,-11797,-11831,-11866,-11901,-11935,-11970,-12004,-12038,-12072,-12106,-12140,-12173,-12207,-12240,-12274,-12307,-12340,
    -12373,-12406,-12439,-12472,-12504,-12537,-12569,-12601,-12633,-12665,-12697,-12729,-12760,-12792,-12823,-12854,-12885,-12916,-12947,-12978,
    -13008,-13039,-13069,-13100,-13130,-13160,-13190,-13219,-13249,-13279,-13308,-13337,-13366,-13395,-13424,-13453,-13482,-13510,-13538,-13567,
    -13595,-13623,-13651,-13678,-13706,-13733,-13761,-13788,-13815,-13842,-13869,-13896,-13922,-13949,-13975,-14001,-14027,-14053,-14079,-14104,
    -14130,-14155,-14181,-14206,-14231,-14256,-14280,-14305,-14329,-14354,-14378,-14402,-14426,-14449,-14473,-14497,-14520,-14543,-14566,-14589,
    -14612,-14635,-14657,-14680,-14702,-14724,-14746,-14768,-14789,-14811,-14832,-14854,-14875,-14896,-14917,-14937,-14958,-14978,-14999,-15019,
    -15039,-15059,-15078,-15098,-15118,-15137,-15156,-15175,-15194,-15213,-15231,-15250,-15268,-15286,-15304,-15322,-15340,-15357,-15375,-15392,
    -15409,-15426,-15443,-15460,-15476,-15493,-15509,-15525,-15541,-15557,-15573,-15588,-15604,-15619,-15634,-15649,-15664,-15679,-15693,-15707,
    -15722,-15736,-15750,-15763,-15777,-15791,-15804,-15817,-15830,-15843,-15856,-15868,-15881,-15893,-15905,-15917,-15929,-15941,-15952,-15964,
    -15975,-15986,-15997,-16008,-16018,-16029,-16039,-16049,-16059,-16069,-16079,-16088,-16098,-16107,-16116,-16125,-16134,-16143,-16151,-16160,
    -16168,-16176,-16184,-16192,-16199,-16207,-16214,-16221,-16228,-16235,-16242,-16248,-16255,-16261,-16267,-16273,-16279,-16284, -16290,-16295,
    -16300,-16305,-16310,-16315,-16319,-16324,-16328,-16332,-16336,-16340,-16343,-16347,-16350,-16353,-16356,-16359,-16362,-16364,-16367,-16369,
    -16371,-16373,-16375,-16376,-16378,-16379,-16380,-16381,-16382,-16383,-16383,-16384,-16384,-16384,-16384,-16384,-16383,-16383,-16382,-16381,
    -16380,-16379,-16378,-16376,-16375,-16373,-16371,-16369,-16367,-16364,-16362,-16359,-16356,-16353,-16350,-16347,-16343,-16340,-16336,-16332,
    -16328,-16324,-16319,-16315,-16310,-16305,-16300,-16295,-16290,-16284,-16279,-16273,-16267,-16261,-16255,-16248,-16242,-16235,-16228,-16221,
    -16214,-16207,-16199,-16192,-16184,-16176,-16168,-16160,-16151,-16143,-16134,-16125,-16116,-16107,-16098,-16088,-16079,-16069,-16059,-16049,
    -16039,-16029,-16018,-16008,-15997,-15986,-15975,-15964,-15952,-15941,-15929,-15917,-15905,-15893,-15881,-15868,-15856,-15843,-15830,-15817,
    -15804,-15791,-15777,-15763,-15750,-15736,-15722,-15707,-15693,-15679,-15664,-15649,-15634,-15619,-15604,-15588,-15573,-15557,-15541,-15525,
    -15509,-15493,-15476,-15460,-15443,-15426,-15409,-15392,-15375,-15357,-15340,-15322,-15304,-15286,-15268,-15250,-15231,-15213,-15194,-15175,
    -15156,-15137,-15118,-15098,-15078,-15059,-15039,-15019,-14999,-14978,-14958,-14937,-14917,-14896,-14875,-14854,-14832,-14811,-14789,-14768,
    -14746,-14724,-14702,-14680,-14657,-14635,-14612,-14589,-14566,-14543,-14520,-14497,-14473,-14449,-14426,-14402,-14378,-14354,-14329,-14305,
    -14280,-14256,-14231,-14206,-14181,-14155,-14130,-14104,-14079,-14053,-14027,-14001,-13975,-13949,-13922,-13896,-13869,-13842,-13815,-13788,
    -13761,-13733,-13706,-13678,-13651,-13623,-13595,-13567,-13538,-13510,-13482,-13453,-13424,-13395,-13366,-13337,-13308,-13279,-13249,-13219,
    -13190,-13160,-13130,-13100,-13069,-13039,-13008,-12978,-12947,-12916,-12885,-12854,-12823,-12792,-12760,-12729,-12697,-12665,-12633,-12601,
    -12569,-12537,-12504,-12472,-12439,-12406,-12373,-12340,-12307,-12274,-12240,-12207,-12173,-12140,-12106,-12072,-12038,-12004,-11970,-11935,
    -11901,-11866,-11831,-11797,-11762,-11727,-11691,-11656,-11621,-11585,-11550,-11514,-11478,-11442,-11406,-11370,-11334,-11297,-11261,-11224,
    -11188,-11151,-11114,-11077,-11040,-11003,-10966,-10928,-10891,-10853,-10815,-10778,-10740,-10702,-10663,-10625,-10587,-10549,-10510,-10471,
    -10433,-10394,-10355,-10316,-10277,-10238,-10198,-10159,-10120,-10080,-10040,-10001,-9961,-9921,-9881,-9841,-9800,-9760,-9720,-9679,-9638,
    -9598,-9557,-9516,-9475,-9434,-9393,-9352,-9310,-9269,-9227,-9186,-9144,-9102,-9061,-9019,-8977,-8935,-8892,-8850,-8808,-8765,-8723,-8680,
    -8638,-8595,-8552,-8509,-8466,-8423,-8380,-8337,-8293,-8250,-8207,-8163,-8119,-8076,-8032,-7988,-7944,-7900,-7856,-7812,-7768,-7723,-7679,
    -7635,-7590,-7545,-7501,-7456,-7411,-7366,-7321,-7276,-7231,-7186,-7141,-7096,-7050,-7005,-6960,-6914,-6868,-6823,-6777,-6731,-6685,-6639,
    -6593,-6547,-6501,-6455,-6409,-6363,-6316,-6270,-6223,-6177,-6130,-6084,-6037,-5990,-5943,-5897,-5850,-5803,-5756,-5708,-5661,-5614,-5567,
    -5520,-5472,-5425,-5377,-5330,-5282,-5235,-5187,-5139,-5092,-5044,-4996,-4948,-4900,-4852,-4804,-4756,-4708,-4660,-4612,-4563,-4515,-4467,
    -4418,-4370,-4321,-4273,-4224,-4176,-4127,-4078,-4030,-3981,-3932,-3883,-3835,-3786,-3737,-3688,-3639,-3590,-3541,-3492,-3442,-3393,-3344,
    -3295,-3246,-3196,-3147,-3098,-3048,-2999,-2949,-2900,-2851,-2801,-2752,-2702,-2652,-2603,-2553,-2503,-2454,-2404,-2354,-2305,-2255,-2205,
    -2155,-2105,-2055,-2006,-1956,-1906,-1856,-1806,-1756,-1706,-1656,-1606,-1556,-1506,-1456,-1406,-1356,-1306,-1255,-1205,-1155,-1105,-1055,
    -1005,-955,-904,-854,-804,-754,-704,-653,-603,-553,-503,-452,-402,-352,-302,-251,-201,-151,-101,-50,
    0,50,101,151,201,251,302,352,402,452,503,553,603,653,704,754,804,854,904,955,1005,1055,1105,1155,1205,1255,1306,1356,1406,1456,1506,
    1556,1606,1656,1706,1756,1806,1856,1906,1956,2006,2055,2105,2155,2205,2255,2305,2354,2404,2454,2503,2553,2603,2652,2702,2752,2801,
    2851,2900,2949,2999,3048,3098,3147,3196,3246,3295,3344,3393,3442,3492,3541,3590,3639,3688,3737,3786,3835,3883,3932,3981,4030,4078,
    4127,4176,4224,4273,4321,4370,4418,4467,4515,4563,4612,4660,4708,4756,4804,4852,4900,4948,4996,5044,5092,5139,5187,5235,5282,5330,
    5377,5425,5472,5520,5567,5614,5661,5708,5756,5803,5850,5897,5943,5990,6037,6084,6130,6177,6223,6270,6316,6363,6409,6455,6501,6547,
    6593,6639,6685,6731,6777,6823,6868,6914,6960,7005,7050,7096,7141,7186,7231,7276,7321,7366,7411,7456,7501,7545,7590,7635,7679,7723,
    7768,7812,7856,7900,7944,7988,8032,8076,8119,8163,8207,8250,8293,8337,8380,8423,8466,8509,8552,8595,8638,8680,8723,8765,8808,8850,
    8892,8935,8977,9019,9061,9102,9144,9186,9227,9269,9310,9352,9393,9434,9475,9516,9557,9598,9638,9679,9720,9760,9800,9841,9881,9921,
    9961,10001,10040,10080,10120,10159,10198,10238,10277,10316,10355,10394,10433,10471,10510,10549,10587,10625,10663,10702,10740,10778,
    10815,10853,10891,10928,10966,11003,11040,11077,11114,11151,11188,11224,11261,11297,11334,11370,11406,11442,11478,11514,11550,11585,
    11621,11656,11691,11727,11762,11797,11831,11866,11901,11935,11970,12004,12038,12072,12106,12140,12173,12207,12240,12274,12307,12340,
    12373,12406,12439,12472,12504,12537,12569,12601,12633,12665,12697,12729,12760,12792,12823,12854,12885,12916,12947,12978,13008,13039,
    13069,13100,13130,13160,13190,13219,13249,13279,13308,13337,13366,13395,13424,13453,13482,13510,13538,13567,13595,13623,13651,13678,
    13706,13733,13761,13788,13815,13842,13869,13896,13922,13949,13975,14001,14027,14053,14079,14104,14130,14155,14181,14206,14231,14256,
    14280,14305,14329,14354,14378,14402,14426,14449,14473,14497,14520,14543,14566,14589,14612,14635,14657,14680,14702,14724,14746,14768,
    14789,14811,14832,14854,14875,14896,14917,14937,14958,14978,14999,15019,15039,15059,15078,15098,15118,15137,15156,15175,15194,15213,
    15231,15250,15268,15286,15304,15322,15340,15357,15375,15392,15409,15426,15443,15460,15476,15493,15509,15525,15541,15557,15573,15588,
    15604,15619,15634,15649,15664,15679,15693,15707,15722,15736,15750,15763,15777,15791,15804,15817,15830,15843,15856,15868,15881,15893,
    15905,15917,15929,15941,15952,15964,15975,15986,15997,16008,16018,16029,16039,16049,16059,16069,16079,16088,16098,16107,16116,16125,
    16134,16143,16151,16160,16168,16176,16184,16192,16199,16207,16214,16221,16228,16235,16242,16248,16255,16261,16267,16273,16279,16284,
    16290,16295,16300,16305,16310,16315,16319,16324,16328,16332,16336,16340,16343,16347,16350,16353,16356,16359,16362,16364,16367,16369,
    16371,16373,16375,16376,16378,16379,16380,16381,16382,16383,16383
};

//2 axis driver parameters initialize
DriverStructTypedef DX[2] =
{
//the first driver
{
    //Driver Information group
    .DriveInfo.I_Max = 180,
    .DriveInfo.TempDtPtr = &ADC1_2_DMA_DATA2.Split.Temp1V_Org,
    .DriveInfo.TempErrPoint = 73,
    .TempBase.AdcOrg = 1632,    //25摄氏度
    .TempBase.AdcOffset = 2036,
    .TempBase.Scale = 8192,
    .TempBase.K = -519,

    //Globle flag
    .GbFlg.ErrMask1 = 0xffff,
    .GbFlg.ErrMask2 = 0xffff,

    //current U phase group
    .CurU.AdcOffset = 2047,
    .CurU.Scale = 8192,
    .CurU.K = 8192,

    //current V phase group
    .CurV.AdcOffset = 2047,
    .CurV.Scale = 8192,
    .CurV.K = 8192,

    //Current I sum group
    .CurIsum.AdcOffset = 2047,
    .CurIsum.Scale = 8192,
    .CurIsum.K = 8192,

    //Feedback group
    .Fbk.CalSpeedRpmCnt = CAL_SPEED_RPM_CNT,
    .Fbk.SpeedLF_N = 35,
    .Fbk.SpeedLF_A = 333,
    .Fbk.SpeedLF_B = -266,
    .Fbk.SpeedLF_C = 87,       //800Hz
    .Fbk.pF_R_Hall = ReadEncHall_1_State,
    .Fbk.pComuEncDt1 = &SPI3_DMA_RD_Buff2[0],    //position data
    .Fbk.pComuEncDt2 = &SPI3_DMA_RD_Buff2[1],    //crc flag and motor temperature
    .Fbk.SetEleAngDec = SINE_TABLE_NUM - (SINE_TABLE_NUM/4),
    //clark group
    //.Clark.

    //park group
    //.Park.

    //park inverse group
    //.ParkInvt.

    //current loop group
    .CurLp.QsumMaxP = 4729*64,   //1.2~2 * VqMaxOutP
    .CurLp.QsumMaxN = -4729*64,
    .CurLp.DsumMaxP = 4729*64,
    .CurLp.DsumMaxN = -4729*64,
    .CurLp.VqMaxOutP = 9459*64,  //q axis positive output max voltage: 1/sqrt(3)*Udc = 0.577*16384=9459
    .CurLp.VqMaxOutN = -9459*64, //q axis negative output max voltage: -1/sqrt(3)*Udc = -0.577*16384=-9459
    .CurLp.VdMaxOutP = 9459*64,  //d axis positive output max voltage: 1/sqrt(3)*Udc = 0.577*16384=9459
    .CurLp.VdMaxOutN = -9459*64, //d axis negative output max voltage: -1/sqrt(3)*Udc = -0.577*16384=-9459
    //.CurLp.CmdIqMax = 1706,   //15Ap max
    .CurLp.CmdIqMax = 341,   //3Ap max
    .CurLp.Kcp = 2457,
    .CurLp.Kci = 128,

    //speed loop group
    .SpdLp.CmdSpeedMaxRpm = 1000,
    .SpdLp.CmdSpeedMaxDec = 1000*65536/1875*512,
    .SpdLp.CmdSpeedMaxDec1d1 = 1100*65536/1875*512,
    .SpdLp.Kvp = 10,
    .SpdLp.Kvi = 0,
    .SpdLp.Kvi32 = 5,
    .SpdLp.FbkType = 0,
    .SpdLp.pCmdSpeedDec = &DX[0].SpdLp.CmdCmdSpeedDec,

    //position loop group
    .PosLp.Kpp = 500,
    .PosLp.ProfileAcce16 = 10,     //10[rps/s]
    .PosLp.ProfileDece16 = 10,     //10[rps/s]
    .PosLp.ProfileAcceCmd = 10736,  //equivalently 10[rps/s] when encoder resolution is 65536
    .PosLp.ProfileDeceCmd = 10736,  //equivalently 10[rps/s] when encoder resolution is 65536
    .PosLp.ProfileAcceAct = 10736,  //equivalently 10[rps/s] when encoder resolution is 65536
    .PosLp.ProfileDeceAct = 10736,  //equivalently 10[rps/s] when encoder resolution is 65536
    .PosLp.CmdProfileSpeed = 5368705,   //300rpm when encoder resolution is 65536
    .PosLp.CmdPos = 0,
    .PosLp.CmdCmdPos = 0,

    //svpwm group
    //.SVPWM_Info.

    //motor iit group
    .MotorIIt.EnableFlag = 1,
    .MotorIIt.UserSetI = 58,             //5.8Ap=4.1Arms because:[DEC Ap]N/10
    .MotorIIt.UserSetII_DEC = 435428,    //square(2048/18 * 5.8)=435428
    .MotorIIt.UserSetT = 234,             //60S because:[S DEC]N/256*1000
    .MotorIIt.UserSetT_DEC = 60*16000,

    //driver iit group
    .DriveIIt.EnableFlag = 1,
    .DriveIIt.UserSetI = 70,             //7.0Ap=4.95Arms because:[DEC Ap]N/10
    .DriveIIt.UserSetII_DEC = 634323,    //square(2048/18 * 7)=414127
    .DriveIIt.UserSetT = 117,            //30S because:[S DEC]N/256*1000
    .DriveIIt.UserSetT_DEC = 30*16000,

    //motor parameter group
    .MotorPar.Group = 10,                    //电机组
    .MotorPar.Type = 'SM',                   //电机类型 is MS:magnetic step motor
    .MotorPar.FB_Type = 0x40,                   //反馈类型
    .MotorPar.FB_Resolution = 65536,         //反馈精度:电机编码器分辨率
    .MotorPar.FB_Scale = 160000,
    .MotorPar.FB_Period = 2,                 //反馈周期:Z信号检查编码器计数
    .MotorPar.Poles = 50,                     //电机极对数
    .MotorPar.ExcitationMode = 0,            //励磁模式
    .MotorPar.ExcitationCurr = 500,          //励磁电流5Ap
    .MotorPar.ExcitationTime = 1500,          //励磁时间
    .MotorPar.IIt_I = 58,                    //电机I2t电流
    .MotorPar.IItFilter = 234,                //电机过温保护时间 5S because:[S DEC]N/256*1000
    .MotorPar.Imax = 65,                     //电机最大电流
    .MotorPar.L = 24,                        //相电感
    .MotorPar.R = 7,                         //相电阻
    .MotorPar.Ke = 270,
    .MotorPar.Kt = 4,
    .MotorPar.Jr = 5,
    .MotorPar.BrakeDutyCycle = 0,
    .MotorPar.BrakeDelay = 10,
    .MotorPar.RotateDir = 0,
    .MotorPar.CurrBW = 100,
    .MotorPar.UsingType = 'SM',
    .MotorPar.WithBrake = 0,
    .MotorPar.pTemp = &SPI3_DMA_RD_Buff2[1],     //the low 8bit is temperature data

    //PWM TIME point
    .PWM_TIMx = TIM1,
    .QEI_TIMx = TIM2,
    .pF_DriverOn = Driver1_On,
    .pF_DriverOff = Driver1_Off,
    .pF_EncPwrOn = Enc1_PowerOn,
    .pF_EncPwrOff = Enc1_PowerOff,
    .pF_DriverErrLedOn = Driver1_ErrLedOn,
    .pF_DriverErrLedOff = Driver1_ErrLedOff,
},

//the second axis driver
{
    //Driver Information group
    .DriveInfo.I_Max = 180,
    .DriveInfo.TempDtPtr = &ADC1_2_DMA_DATA2.Split.Temp2V_Org,
    .DriveInfo.TempErrPoint = 73,
    .TempBase.AdcOrg = 1632,    //25摄氏度
    .TempBase.AdcOffset = 2036,
    .TempBase.Scale = 8192,
    .TempBase.K = -519,

    //Globle flag
    .GbFlg.ErrMask1 = 0xffff,
    .GbFlg.ErrMask2 = 0xffff,

    //current U phase group
    .CurU.AdcOffset = 2047,
    .CurU.Scale = 8192,
    .CurU.K = 8192,

    //current V phase group
    .CurV.AdcOffset = 2047,
    .CurV.Scale = 8192,
    .CurV.K = 8192,

    //Current I sum group
    .CurIsum.AdcOffset = 2047,
    .CurIsum.Scale = 8192,
    .CurIsum.K = 8192,

    //Feedback group
    .Fbk.CalSpeedRpmCnt = CAL_SPEED_RPM_CNT,
    .Fbk.SpeedLF_N = 35,
    .Fbk.SpeedLF_A = 333,
    .Fbk.SpeedLF_B = -266,
    .Fbk.SpeedLF_C = 87,       //800Hz
    .Fbk.pF_R_Hall = ReadEncHall_1_State,
    .Fbk.pComuEncDt1 = &SPI3_DMA_RD_Buff2[4],    //position data
    .Fbk.pComuEncDt2 = &SPI3_DMA_RD_Buff2[5],    //crc flag and motor temperature
    .Fbk.SetEleAngDec = SINE_TABLE_NUM - (SINE_TABLE_NUM/4),
    //clark group
    //.Clark.

    //park group
    //.Park.

    //park inverse group
    //.ParkInvt.

    //current loop group
    .CurLp.QsumMaxP = 4729*64,   //1.2~2 * VqMaxOutP
    .CurLp.QsumMaxN = -4729*64,
    .CurLp.DsumMaxP = 4729*64,
    .CurLp.DsumMaxN = -4729*64,
    .CurLp.VqMaxOutP = 9459*64,  //q axis positive output max voltage: 1/sqrt(3)*Udc = 0.577*16384=9459
    .CurLp.VqMaxOutN = -9459*64, //q axis negative output max voltage: -1/sqrt(3)*Udc = -0.577*16384=-9459
    .CurLp.VdMaxOutP = 9459*64,  //d axis positive output max voltage: 1/sqrt(3)*Udc = 0.577*16384=9459
    .CurLp.VdMaxOutN = -9459*64, //d axis negative output max voltage: -1/sqrt(3)*Udc = -0.577*16384=-9459
    //.CurLp.CmdIqMax = 1706,   //15Ap max
    .CurLp.CmdIqMax = 341,   //3Ap max
    .CurLp.Kcp = 2457,
    .CurLp.Kci = 128,

    //speed loop group
    .SpdLp.CmdSpeedMaxRpm = 1000,
    .SpdLp.CmdSpeedMaxDec = 1000*65536/1875*512,
    .SpdLp.CmdSpeedMaxDec1d1 = 1100*65536/1875*512,
    .SpdLp.Kvp = 10,
    .SpdLp.Kvi = 0,
    .SpdLp.Kvi32 = 5,
    .SpdLp.FbkType = 0,
    .SpdLp.pCmdSpeedDec = &DX[1].SpdLp.CmdCmdSpeedDec,

    //position loop group
    .PosLp.Kpp = 500,
    .PosLp.ProfileAcce16 = 10,     //10[rps/s]
    .PosLp.ProfileDece16 = 10,     //10[rps/s]
    .PosLp.ProfileAcceAct = 10736,  //equivalently 10[rps/s] when encoder resolution is 65536
    .PosLp.ProfileDeceAct = 10736,  //equivalently 10[rps/s] when encoder resolution is 65536
    .PosLp.CmdProfileSpeed = 5368705,   //300rpm when encoder resolution is 65536
    .PosLp.CmdPos = 0,
    .PosLp.CmdCmdPos = 0,

    //svpwm group
    //.SVPWM_Info.

    //motor iit group
    .MotorIIt.EnableFlag = 1,
    .MotorIIt.UserSetI = 58,             //5.8Ap=4.1Arms because:[DEC Ap]N/10
    .MotorIIt.UserSetII_DEC = 435428,    //square(2048/18 * 5.8)=435428
    .MotorIIt.UserSetT = 234,             //60S because:[S DEC]N/256*1000
    .MotorIIt.UserSetT_DEC = 60*16000,

    //driver iit group
    .DriveIIt.EnableFlag = 1,
    .DriveIIt.UserSetI = 70,             //7.0Ap=4.95Arms because:[DEC Ap]N/10
    .DriveIIt.UserSetII_DEC = 634323,    //square(2048/18 * 7)=414127
    .DriveIIt.UserSetT = 117,            //30S because:[S DEC]N/256*1000
    .DriveIIt.UserSetT_DEC = 30*16000,

    //motor parameter group
    .MotorPar.Group = 10,                    //电机组
    .MotorPar.Type = 'SM',                   //电机类型 is MS:magnetic step motor
    .MotorPar.FB_Type = 0x40,                   //反馈类型
    .MotorPar.FB_Resolution = 65536,         //反馈精度:电机编码器分辨率
    .MotorPar.FB_Scale = 160000,
    .MotorPar.FB_Period = 2,                 //反馈周期:Z信号检查编码器计数
    .MotorPar.Poles = 50,                     //电机极对数
    .MotorPar.ExcitationMode = 0,            //励磁模式
    .MotorPar.ExcitationCurr = 500,          //励磁电流5Ap
    .MotorPar.ExcitationTime = 1500,          //励磁时间
    .MotorPar.IIt_I = 58,                    //电机I2t电流
    .MotorPar.IItFilter = 234,                //电机过温保护时间 5S because:[S DEC]N/256*1000
    .MotorPar.Imax = 65,                     //电机最大电流
    .MotorPar.L = 24,                        //相电感
    .MotorPar.R = 7,                         //相电阻
    .MotorPar.Ke = 270,
    .MotorPar.Kt = 4,
    .MotorPar.Jr = 5,
    .MotorPar.BrakeDutyCycle = 0,
    .MotorPar.BrakeDelay = 10,
    .MotorPar.RotateDir = 0,
    .MotorPar.CurrBW = 100,
    .MotorPar.UsingType = 'SM',
    .MotorPar.WithBrake = 0,
    .MotorPar.pTemp = &SPI3_DMA_RD_Buff2[5],     //the low 8bit is temperature data

    //PWM TIME point
    .PWM_TIMx = TIM8,
    .QEI_TIMx = TIM4,
    .pF_DriverOn = Driver2_On,
    .pF_DriverOff = Driver2_Off,
    .pF_EncPwrOn = Enc2_PowerOn,
    .pF_EncPwrOff = Enc2_PowerOff,
    .pF_DriverErrLedOn = Driver2_ErrLedOn,
    .pF_DriverErrLedOff = Driver2_ErrLedOff,
},
};
//the 2 driver common
DriverStructComTypedef DXC =
{
    /*
    .ComInfo.DC_BusUnder = 28,
    .ComInfo.DC_BusUnderDec = 2048,     //DC_BusUnder = (DC_BusUnderDec - Offset)*K/Scale
    .ComInfo.DC_BusOver = 49,
    .ComInfo.DC_BusOverDec = 3584,      //DC_BusOver = (DC_BusOverDec - Offset)*K/Scale
    .ComInfo.ChopVolt = 46,
    .ComInfo.ChopVoltDec = 3364,        //ChopVolt = (ChopVoltDec - Offset)*K/Scale
    .ComInfo.ChopVoltOffDec = 3145,      //43V off chop
    .ComInfo.TempErrPoint = 75,
*/
     //for 大道智创
    .ComInfo.DC_BusUnder = 28,
    .ComInfo.DC_BusUnderDec = 2048,     //DC_BusUnder = (DC_BusUnderDec - Offset)*K/Scale
    .ComInfo.DC_BusOver = 60,
    .ComInfo.DC_BusOverDec = 4388,      //DC_BusOver = (DC_BusOverDec - Offset)*K/Scale，因为硬件测量量程有问题，所以4388相当于没有过压保护了
    .ComInfo.ChopVolt = 46,
    .ComInfo.ChopVoltDec = 4096,        //ChopVolt = (ChopVoltDec - Offset)*K/Scale
    .ComInfo.ChopVoltOffDec = 4090,      //43V off chop
    .ComInfo.TempErrPoint = 75,

    .BrakeIIt.EnableFlag = 1,
    .BrakeIIt.UserSetI = 60,             //6Amp because:[DEC Ap]N/10
    .BrakeIIt.UserSetII_DEC = 465578,    //sqr(2048/18 * 6)=
    .BrakeIIt.UserSetT = 20,             //5S because:[S DEC]N/256*1000
    .BrakeIIt.UserSetT_DEC = 5*16000,

    .CurrBk.AdcOffset = 2024,
    .CurrBk.Scale = 8192,
    .CurrBk.K = 8192,

    .DC_BusVolt.AdcOffset = 0,
    .DC_BusVolt.Scale = 8192,
    .DC_BusVolt.K = 112,

    .TempBase.AdcOrg = 1632,    //25摄氏度
    .TempBase.AdcOffset = 2036,
    .TempBase.Scale = 8192,
    .TempBase.K = -519,

    .CurrDm.AdcOffset = 3170,
    .CurrDm.Scale = 819,
    .CurrDm.K = -6670,

    .DM_IIt.EnableFlag = 1,
    .DM_IIt.UserSetI = 3000,           //3000mA
    .DM_IIt.UserSetII_DEC = 9000000,   //sqr(3000)=4000000
    .DM_IIt.UserSetT = 3,             //3S
    .DM_IIt.UserSetT_DEC = 3*16000,   //2s

    .DM_Ctrl.EnableFlag = 1,
    .DM_Ctrl.Speed[1] = 1000,
    .DM_Ctrl.Speed[2] = 2150,
    .DM_Ctrl.Speed[3] = 3150,
    .DM_Ctrl.SpeedSelect = 2,

    .Dout.Mask = 0xffff,

    .PlatformInfo.Pos.pCntOrg = &SPI3_DMA_RD_Buff2[10],

    .ExtAi[0].AiBase.pAdcOrg = &ADC1_2_DMA_DATA2.Split.Ain1V_Org,
    .ExtAi[0].AiBase.AdcOffset = 2048,
    .ExtAi[0].AiBase.Scale = 1024,
    .ExtAi[0].AiBase.K = 8192,
    .ExtAi[0].Lp1f.CfftA = 64261,
    .ExtAi[0].Lp1f.Enable = 1,

    .ExtAi[1].AiBase.pAdcOrg = &ADC1_2_DMA_DATA2.Split.Ain2V_Org,
    .ExtAi[1].AiBase.AdcOffset = 2048,
    .ExtAi[1].AiBase.Scale = 1024,
    .ExtAi[1].AiBase.K = 8192,
    .ExtAi[1].Lp1f.CfftA = 64261,
    .ExtAi[1].Lp1f.Enable = 1,

    .ExtAi[2].AiBase.pAdcOrg = &ADC1_2_DMA_DATA2.Split.Ain3V_Org,
    .ExtAi[2].AiBase.AdcOffset = 2048,
    .ExtAi[2].AiBase.Scale = 1024,
    .ExtAi[2].AiBase.K = 8192,
    .ExtAi[2].Lp1f.CfftA = 64261,
    .ExtAi[2].Lp1f.Enable = 1,

    .ExtAi[3].AiBase.pAdcOrg = &ADC1_2_DMA_DATA2.Split.Ain4V_Org,
    .ExtAi[3].AiBase.AdcOffset = 2048,
    .ExtAi[3].AiBase.Scale = 1024,
    .ExtAi[3].AiBase.K = 8192,
    .ExtAi[3].Lp1f.CfftA = 64261,
    .ExtAi[3].Lp1f.Enable = 1,
};



//calculate the real current unit:dec
void CalAnalogRealDec(AnalogGroupBaseTypedef* pAlgBase)
{
    pAlgBase->AdcOrgAct = (INT16S)pAlgBase->AdcOrg - pAlgBase->AdcOffset;
    pAlgBase->AdcRealDec = (INT32S)(pAlgBase->AdcOrgAct) * (pAlgBase->K) / (INT32S)(pAlgBase->Scale);
}

//Clark transform
void ClarkTransform(ClarkTypedef* pClark, FeedbackTypedef* pFbk)
{
    pClark->Ialpha = pFbk->Iu;
    pClark->Ibeta  = (((INT32S)(pFbk->Iu))*2365+((INT32S)(pFbk->Iv))*4730)/4096;  // (ia+2ib)/sqrt(3) 2365 是3开平方放大4096.
}


#if 1
//Park tansform
//eAngle do not big than SINE_TABLE_NUM
void ParkTansform(ParkTypedef* pPark, ClarkTypedef* pClark, FeedbackTypedef* pFbk)
{
    INT16U e_angle;
    e_angle = pFbk->EleAngDec;
    pPark->SinVal = SinTable[e_angle];
    pPark->CosVal = CosTable[e_angle];
    pPark->Iq = ((-pClark->Ialpha)*(INT32S)(pPark->SinVal)+((INT32S)(pClark->Ibeta)*(pPark->CosVal)))/SINE_COSINE_VALUE_MAX;
    pPark->Id = ((pClark->Ialpha)*(INT32S)(pPark->CosVal)+((INT32S)(pClark->Ibeta)*(pPark->SinVal)))/SINE_COSINE_VALUE_MAX;
    //for high speed
    e_angle = pFbk->EleAngDec + pFbk->EleAngOffsetDec;
    pPark->SinVal = SinTable[e_angle];
    pPark->CosVal = CosTable[e_angle];
}
#endif

//inverse park transformation
void ParkInvtTansform(ParkInvertTypedef* pParkInvt,ParkTypedef* pPark,CurrLoopTypedef* pCurLp)
{
    pParkInvt->Valpha = ((INT32S)(pCurLp->VdOut) * pPark->CosVal - (INT32S)(pCurLp->VqOut) * pPark->SinVal)/SINE_COSINE_VALUE_MAX;
    pParkInvt->Vbeta  = ((INT32S)(pCurLp->VdOut) * pPark->SinVal + (INT32S)(pCurLp->VqOut) * pPark->CosVal)/SINE_COSINE_VALUE_MAX;
}
//7 segment SVPWM generator
ResultStatus Gen7SegSVPWM(SVPWM_InfoTypedef* pSVPWM_Info, ParkInvertTypedef* pParkInvt)
{
    ResultStatus rlt_status = RLT_NO_ERR;
    INT8U  a = 0;
    INT8U  b = 0;
    INT8U  c = 0;
    INT8U  i = 0;
    INT8U  section[8]= {0,2,6,1,4,3,5,7};
    INT16S tx = 0;
    INT16S ty = 0;
    INT32S txy = 0;
    INT16U taon = 0;
    INT16U tbon = 0;
    INT16U tcon = 0;
    pSVPWM_Info->Vr1 = pParkInvt->Vbeta;
    pSVPWM_Info->Vr2 = (14189 * (INT32S)(pParkInvt->Valpha) - 8192 * (INT32S)(pParkInvt->Vbeta))/16384;
    pSVPWM_Info->Vr3 = (-14189 * (INT32S)(pParkInvt->Valpha) - 8192 * (INT32S)(pParkInvt->Vbeta))/16384;
    if(pSVPWM_Info->Vr1 > 0)
    {
        a = 1;
    }
    else
    {
        a = 0;
    }
    if(pSVPWM_Info->Vr2 > 0)
    {
        b = 1;
    }
    else
    {
        b = 0;
    }
    if(pSVPWM_Info->Vr3 > 0)
    {
        c = 1;
    }
    else
    {
        c = 0;
    }
    i=4*c+2*b+a;
    switch(section[i])
    {
    case 1:  //第一个扇区
        tx = (pSVPWM_Info->Vr2);
        ty = (pSVPWM_Info->Vr1);
        break;
    case 2:  //第二个扇区
        tx = -(pSVPWM_Info->Vr2);
        ty = -(pSVPWM_Info->Vr3);
        break;
    case 3:  //第三个扇区
        tx = (pSVPWM_Info->Vr1);
        ty = (pSVPWM_Info->Vr3);
        break;
    case 4:  //第四个扇区
        tx = -(pSVPWM_Info->Vr1);
        ty = -(pSVPWM_Info->Vr2);
        break;
    case 5:  //第五个扇区
        tx = (pSVPWM_Info->Vr3);
        ty = (pSVPWM_Info->Vr2);
        break;
    case 6:  //第六个扇区
        tx = -(pSVPWM_Info->Vr3);
        ty = -(pSVPWM_Info->Vr1);
        break;
    default:
        tx = 0;
        ty = 0;
        break;
    };
    if((tx<0)||(ty<0))
    {
        rlt_status = RLT_ERR;
        return rlt_status;
    }
#if 1
    //PWM_PERIOD define in time.h
    tx = (INT32S)tx  * PWM_PERIOD / 9459;       //9459 = 16384*2/sqrt(3)
    ty = (INT32S)ty  * PWM_PERIOD / 9459;
    //we only use 84%PWM,remain 10us at least for U,V current ADC sample
    txy = tx + ty;
    if((txy) > ((PWM_PERIOD*84)/100))
    {
        tx = (INT32S)tx * ((PWM_PERIOD*84)/100) / (txy);
        ty = (INT32S)ty * ((PWM_PERIOD*84)/100) / (txy);
    }
    taon = (PWM_PERIOD - tx - ty) / 2;
    tbon = (taon + tx);
    tcon = (tbon + ty);
#endif

    switch(section[i])
    {
    case 1:
        pSVPWM_Info->CCRU = taon;
        pSVPWM_Info->CCRV = tbon;
        pSVPWM_Info->CCRW = tcon;
        break;
    case 2:
        pSVPWM_Info->CCRU = tbon;
        pSVPWM_Info->CCRV = taon;
        pSVPWM_Info->CCRW = tcon;
        break;
    case 3:
        pSVPWM_Info->CCRU = tcon;
        pSVPWM_Info->CCRV = taon;
        pSVPWM_Info->CCRW = tbon;
        break;
    case 4:
        pSVPWM_Info->CCRU = tcon;
        pSVPWM_Info->CCRV = tbon;
        pSVPWM_Info->CCRW = taon;
        break;
    case 5:
        pSVPWM_Info->CCRU = tbon;
        pSVPWM_Info->CCRV = tcon;
        pSVPWM_Info->CCRW = taon;
        break;
    case 6:
        pSVPWM_Info->CCRU = taon;
        pSVPWM_Info->CCRV = tcon;
        pSVPWM_Info->CCRW = tbon;
        break;
    default:
#if(SVPWM_OUT_POLARITY == 0)
        pSVPWM_Info->CCRU = PWM_PERIOD;  //all output be low
        pSVPWM_Info->CCRV = PWM_PERIOD;
        pSVPWM_Info->CCRW = PWM_PERIOD;
#else
        pSVPWM_Info->CCRU = 0;  //all output be low
        pSVPWM_Info->CCRV = 0;
        pSVPWM_Info->CCRW = 0;
#endif
        break;
    }
    return rlt_status;
}
//PWM 输出比较值更新
void PWM_ValueUpdata(TIM_TypeDef* TIMx, SVPWM_InfoTypedef* pSVPWM_Info)
{
#if(SVPWM_OUT_POLARITY == 0)
    TIMx->CCR1 = PWM_PERIOD - (pSVPWM_Info->CCRU);
    TIMx->CCR2 = PWM_PERIOD - (pSVPWM_Info->CCRV);
    TIMx->CCR3 = PWM_PERIOD - (pSVPWM_Info->CCRW);
#else
    TIMx->CCR1 = (pSVPWM_Info->CCRU);
    TIMx->CCR2 = (pSVPWM_Info->CCRV);
    TIMx->CCR3 = (pSVPWM_Info->CCRW);
#endif
}
//get the position increment from ABZ encoder
void GetPositionIncrementABZ(FeedbackTypedef* pFbk, TIM_TypeDef* TIMx)
{
    UNION_DATA_DEF un_temp32;

    //get the position
    pFbk->QEI_CntNow = TIMx->CNT;
    un_temp32.Int32s = (INT32S)pFbk->QEI_CntNow - (INT32S)pFbk->QEI_CntLast;
    un_temp32.Int32s = un_temp32.Int32s & 0x0000ffff;
    un_temp32.Int32s = (INT32S)(un_temp32.Int16s);
    pFbk->QEI_CntLast = pFbk->QEI_CntNow;
    pFbk->PosAbs += un_temp32.Int32s;
}

//get the pulse count
void GetPulseCount(PulseCountTypedef* pPCnt)
{
    UNION_DATA_DEF un_temp32;

    //get the position
    //pPCnt->CntNow = TIMx->CNT;
    pPCnt->CntNow = *(pPCnt->pCntOrg);
    un_temp32.Int32s = (INT32S)pPCnt->CntNow - (INT32S)pPCnt->CntLast;
    un_temp32.Int32s = un_temp32.Int32s & 0x0000ffff;
    un_temp32.Int32s = (INT32S)(un_temp32.Int16s);
    pPCnt->CntLast = pPCnt->CntNow;
    pPCnt->AllPulse.Int32s += un_temp32.Int32s;
}

//get the position increment from comunication encoder
void GetPositionComu(FeedbackTypedef* pFbk)
{
    UNION_DATA_DEF un_temp32;
    INT16U  temp16u;

    //get the position
    if((*(pFbk->pComuEncDt2) & 0x8000) != 0x8000)
    {
        if(pFbk->EncPwOnInitFlag == 1)
        {
            pFbk->EncPwOnInitCnt ++;
            if(pFbk->EncPwOnInitCnt > 20*16)    //20ms
            {
                pFbk->EncPwOnInitCnt = 0;
                pFbk->EncPwOnInitFlag = 0;
            }
        }
        else
        {

            if(pFbk->ComuEncErrFlag == 0)
            {
                pFbk->PosAbs += pFbk->DeltaPos;
                pFbk->ComuEncErrCnt ++;
                if(pFbk->ComuEncErrCnt >= 3)
                {
                    pFbk->ComuEncErrFlag = 1;
                }
            }
        }
    }
    else
    {
        pFbk->EncPwOnInitFlag == 0;
        if(pFbk->ComuEncErrCnt != 0)
        {
            pFbk->ComuEncErrCnt --;
        }
        pFbk->QEI_CntNow = *(pFbk->pComuEncDt1);
        un_temp32.Int32s = (INT32S)pFbk->QEI_CntNow - (INT32S)pFbk->QEI_CntLast;
        un_temp32.Int32s = un_temp32.Int32s & 0x0000ffff;
        un_temp32.Int32s = (INT32S)(un_temp32.Int16s);
        pFbk->QEI_CntLast = pFbk->QEI_CntNow;
        pFbk->PosAbs += un_temp32.Int32s;
        pFbk->DeltaPos = un_temp32.Int32s;

        un_temp32.Int32s = pFbk->PosAbs - pFbk->PosAbsLast;
        un_temp32.Int32s += pFbk->PosAbsFlt;
        pFbk->PosAbs32 += (un_temp32.Int32s/16);
        pFbk->PosAbsFlt = (un_temp32.Int32s%16);
        pFbk->PosAbsLast = pFbk->PosAbs;
    }


}


#if 1
//calculate the eletronic angle
void CalEletronicAngleDec(FeedbackTypedef* pFbk, MotorParameterTypedef* pMotorPar)
{
    INT32S  temp32u;
    INT16U  temp16u;
    if(pFbk->QEI_CntNow >= pFbk->EncOffset16)
    {
        temp16u = pFbk->QEI_CntNow - pFbk->EncOffset16;
    }
    else
    {
        temp16u = pFbk->EncOffset16 - pFbk->QEI_CntNow;
        temp16u = pMotorPar->FB_Resolution - temp16u;
    }

    temp32u = (INT32U)temp16u * (pMotorPar->Poles);
    pFbk->EleAngDec = (SINE_TABLE_NUM * (temp32u%(pMotorPar->FB_Resolution))) / (pMotorPar->FB_Resolution);
}
#endif

//calculate speed via 2 orde low pass filter
//Kinco speed RPM->DEC: (N/1875)*512*Encoder_R, here let K*(N*Encoder_R/(160000*60/4) = (N/1875)*512*Encoder_R
//so we get the K=65536
//This speed must be calculated every 250us=4/Fpwm
void CalFilterSpeed(FeedbackTypedef* pFbk)
{
    UNION_DATA_DEF temp32;
    INT32S  lf_last = 0;
    INT32S  lf_last_last = 0;
    if(pFbk->CalSpeedFilterInit <= 4)
    {
        pFbk->SpeedFilterUsePosLast = pFbk->PosAbs;
        pFbk->CalSpeedFilterInit ++ ;
    }
    else
    {
    if((pFbk->CalSpeedFilterCnt & 0x0003) == 0x0000)
    {
        //pFbk->SpeedOrgDec = 65536 * (PosNew - PosLast);
        //pFbk->SpeedFilterOrg =  (pFbk->SpeedOrgDec)/64;
        pFbk->SpeedOrgDec = pFbk->PosAbs - pFbk->SpeedFilterUsePosLast;
        pFbk->SpeedFilterOrg = 1024*(INT32S)(pFbk->SpeedOrgDec);
        temp32.Int32s = (INT32S)pFbk->SpeedLF_FltLast * pFbk->SpeedLF_B;
        lf_last = temp32.Int32s/512;
        temp32.Int32s = (INT32S)pFbk->SpeedLF_FltLastLast * pFbk->SpeedLF_C;
        lf_last_last = temp32.Int32s/512;
        temp32.Int32s = (INT32S)(pFbk->SpeedLF_A)*(pFbk->SpeedFilterOrg) - (INT32S)(pFbk->SpeedLF_B)*(pFbk->SpeedFilterNow) - lf_last\
                        - (INT32S)pFbk->SpeedLF_C*(pFbk->SpeedFilterLast) - lf_last_last;

        pFbk->SpeedFilterLast = pFbk->SpeedFilterNow;
        pFbk->SpeedFilterNow = temp32.Int32s/512;
        pFbk->SpeedLF_FltLastLast = pFbk->SpeedLF_FltLast;
        pFbk->SpeedLF_FltLast = temp32.Int32s%(INT32S)512;
        pFbk->SpeedFilterDec = 64*(pFbk->SpeedFilterNow);
        pFbk->SpeedFilterUsePosLast = pFbk->PosAbs;
    }
    pFbk->CalSpeedFilterCnt ++;
    }
}

//clear filter speed data at encoder error
void ClrEncErrData(FeedbackTypedef* pFbk, TIM_TypeDef* TIMx)
{
    pFbk->QEI_CntNow = 0;
    pFbk->QEI_CntLast = 0;
    pFbk->PosMgtAbs = 0;
    pFbk->PosAbs = 0;
    pFbk->PosAbsLast = 0;
    pFbk->PosAbs32 = 0;
    pFbk->PosAbsFlt = 0;
    pFbk->SpeedFilterUsePosLast = 0;
    pFbk->SpeedOrgDec = 0;
    pFbk->SpeedFilterOrg = 0;
    pFbk->SpeedLF_FltLast = 0;
    pFbk->SpeedLF_FltLastLast = 0;
    pFbk->SpeedFilterLast = 0;
    pFbk->SpeedFilterNow = 0;
    pFbk->SpeedFilterDec = 0;
    pFbk->CalSpeedFilterInit = 0;
    pFbk->CalSpeedFilterCnt = 0;

    pFbk->FirstZ = 0;
    pFbk->PosOnFirstZ = 0;
    pFbk->EncOffset = 0;

    TIMx->CNT = 0;
    pFbk->ComuEncErrFlag = 0;
    pFbk->ComuEncErrCnt = 0;
    pFbk->EncPwOnInitCnt = 0;
    pFbk->DeltaPos = 0;
}

//calculate speed unit:RPM
//every 200ms calculate
void CalSpeedRPM(FeedbackTypedef* pFbk, INT32S FB_Resolution)
{
    INT32S  temp32s;

    pFbk->CalSpeedRpmCnt ++;
    if(pFbk->CalSpeedRpmCnt >= CAL_SPEED_RPM_CNT)
    {
        pFbk->CalSpeedRpmCnt = 0;
        temp32s = (pFbk->PosAbs - pFbk->SpeedRpmUsePosLast) * CAL_SPEED_RPM_FTR;
        pFbk->RealSpeedRpm = temp32s/(INT32S)FB_Resolution;   //notice:sign symbol depend on divisor
        //SpdLp.RealSpeedRpm2 = temp32s%(INT32S)Motor.FB_Resolution;
        pFbk->SpeedRpmUsePosLast = pFbk->PosAbs;
    }
}


#if 1   //位置式电流环PI
//current loop PI adjust
void CurrentLoopPI(CurrLoopTypedef* pCurLp, ParkTypedef* pPark)
{
    INT16S back_emf = 0;  //the back emf voltage. that is ke*Vspeed
    INT32S temp32s;
    //static INT16S DeltaIqNow,DeltaIdNow,DeltaIqLast,DeltaIdLast;
    //KpCurr = 64*PWM_Fcy * L_Qaxis * MaxCurr /12500/UdcVol;
    //KiCurr = R_Qaxis * MaxCurr * 128 / UdcVol /25;
    pCurLp->DeltaIqNow = pCurLp->CmdIqAct - pPark->Iq;
    pCurLp->DeltaIdNow = pCurLp->CmdIdAct - pPark->Id;

//Q轴PI
    pCurLp->VqKiSum += (INT32S)pCurLp->Kci * (INT32S)pCurLp->DeltaIqNow;
    //q积分限制
    if(pCurLp->VqKiSum > pCurLp->QsumMaxP)
    {
        pCurLp->VqKiSum = pCurLp->QsumMaxP;
    }
    else
    {
        if(pCurLp->VqKiSum < pCurLp->QsumMaxN)
            pCurLp->VqKiSum = pCurLp->QsumMaxN;
    }
    pCurLp->VqKp = (INT32S)pCurLp->Kcp * (INT32S)pCurLp->DeltaIqNow;
    pCurLp->Vq = pCurLp->VqKp + pCurLp->VqKiSum;
    if(pCurLp->Vq > pCurLp->VqMaxOutP)
    {
        pCurLp->VqOut = pCurLp->VqMaxOutP/64;
        temp32s = pCurLp->Vq - pCurLp->VqMaxOutP;
        if(temp32s > pCurLp->VqKiSum)
            pCurLp->VqKiSum = 0;
        else
            pCurLp->VqKiSum = pCurLp->VqKiSum - temp32s;
    }
    else if(pCurLp->Vq < pCurLp->VqMaxOutN)
    {
        pCurLp->VqOut = pCurLp->VqMaxOutN/64;
        temp32s = pCurLp->Vq - pCurLp->VqMaxOutN;
        if(temp32s < pCurLp->VqKiSum)
            pCurLp->VqKiSum = 0;
        else
            pCurLp->VqKiSum = pCurLp->VqKiSum - temp32s;
    }
    else
    {
        pCurLp->VqOut = pCurLp->Vq/64;
    }

//d轴PI
    pCurLp->VdKiSum += (INT32S)pCurLp->Kci * (INT32S)pCurLp->DeltaIdNow;
    //d积分限制
    if(pCurLp->VdKiSum > pCurLp->DsumMaxP)
    {
        pCurLp->VdKiSum = pCurLp->DsumMaxP;
    }
    else
    {
        if(pCurLp->VdKiSum < pCurLp->DsumMaxN)
            pCurLp->VdKiSum = pCurLp->DsumMaxN;
    }
    pCurLp->VdKp = (INT32S)pCurLp->Kcp * (INT32S)pCurLp->DeltaIdNow;
    pCurLp->Vd = pCurLp->VdKp + pCurLp->VdKiSum;
    if(pCurLp->Vd > pCurLp->VdMaxOutP)
    {
        pCurLp->VdOut = pCurLp->VdMaxOutP/64;
        temp32s = pCurLp->Vd - pCurLp->VdMaxOutP;
        if(temp32s > pCurLp->VdKiSum)
            pCurLp->VdKiSum = 0;
        else
            pCurLp->VdKiSum = pCurLp->VdKiSum - temp32s;
    }
    else if(pCurLp->Vd < pCurLp->VdMaxOutN)
    {
        pCurLp->VdOut = pCurLp->VdMaxOutN/64;
        temp32s = pCurLp->Vd - pCurLp->VdMaxOutN;
        if(temp32s < pCurLp->VdKiSum)
            pCurLp->VdKiSum = 0;
        else
            pCurLp->VdKiSum = pCurLp->VdKiSum - temp32s;
    }
    else
    {
        pCurLp->VdOut = pCurLp->Vd/64;
    }

}
#endif


//speed loop PI adjust
void SpeedLoopPI(SpeedLoopTypedef* pSpdLp, FeedbackTypedef* pFbk, INT16U OutLimit)
{
#if 1   //积分方式改变
    INT32S temp32s;
    INT32S temp32_32s;
    INT32S temp_out_limit;
    if(pSpdLp->FbkType == 0)    //filter speed as the feedback
    {
        pSpdLp->DeltaSpeedNowDec =    (pSpdLp->CmdSpeedDecAct - pFbk->SpeedFilterDec)/256;
    }
    else if(pSpdLp->FbkType == 1)   //original speed as the feedback
    {
        pSpdLp->DeltaSpeedNowDec =    (pSpdLp->CmdSpeedDecAct - 65536*(INT32S)pFbk->SpeedOrgDec)/256;
    }


    if(pSpdLp->Kvi == 0)
    {
        pSpdLp->SpeedKiSum32 = 0;
    }
    else
    {
        temp32s = (INT32S)pSpdLp->Kvi * pSpdLp->DeltaSpeedNowDec;
        pSpdLp->SpeedKiSum32 += temp32s;
    }
    pSpdLp->SpeedKiSum = pSpdLp->SpeedKiSum32 / 32;

     //动态调节积分限制
    if(pSpdLp->CmdSpeedDecAct < 0)
        temp32s = -(pSpdLp->CmdSpeedDecAct);
    else
        temp32s = (pSpdLp->CmdSpeedDecAct);

    if(temp32s < 17895*200) //200rpm
    {
        temp_out_limit = pSpdLp->SpeedKiSumLimit;
    }
    else if(temp32s < 17895*300)
    {
        temp_out_limit = 113*8*256;
    }
    else if(temp32s < 17895*400)
    {
        temp_out_limit = 113*4*256;
    }
    else if(temp32s < 17895*450)
    {
        temp_out_limit = 113*2*256;
    }
    else if(temp32s < 17895*500)
    {
        temp_out_limit = 113*1*256;
    }
    else
    {
        temp_out_limit = 60*256;
    }

    if(temp_out_limit > pSpdLp->SpeedKiSumLimit)
        temp_out_limit = pSpdLp->SpeedKiSumLimit;
    //积分输出限制
    if(pSpdLp->SpeedKiSum > temp_out_limit)
    {
        pSpdLp->SpeedKiSum = temp_out_limit;
        pSpdLp->SpeedKiSum32 = pSpdLp->SpeedKiSum * 32;
    }
    else if(pSpdLp->SpeedKiSum < -temp_out_limit)
    {
        pSpdLp->SpeedKiSum = -temp_out_limit;
        pSpdLp->SpeedKiSum32 = pSpdLp->SpeedKiSum * 32;
    }

    //位置式输出
    pSpdLp->SpeedKp = (INT32S)pSpdLp->Kvp * pSpdLp->DeltaSpeedNowDec;
    pSpdLp->SpeedCmdIq = pSpdLp->SpeedKp + pSpdLp->SpeedKiSum;
    temp_out_limit = (INT32S)OutLimit * 256;
    if(pSpdLp->SpeedCmdIq > temp_out_limit)
    {
        pSpdLp->OutCmdIq = OutLimit;
        temp32s = pSpdLp->SpeedCmdIq - temp_out_limit;
        if(temp32s > pSpdLp->SpeedKiSum)
        {
            pSpdLp->SpeedKiSum32 = 0;
        }
        else
            pSpdLp->SpeedKiSum32 -= (temp32s * 32);
    }
    else if(pSpdLp->SpeedCmdIq < -temp_out_limit)
    {
        pSpdLp->OutCmdIq = -OutLimit;
        temp32s = pSpdLp->SpeedCmdIq - (-temp_out_limit);
        if(temp32s < pSpdLp->SpeedKiSum)
        {
            pSpdLp->SpeedKiSum32 = 0;
        }
        else
            pSpdLp->SpeedKiSum32 -= (temp32s * 32);
    }
    else
    {
        pSpdLp->OutCmdIq = pSpdLp->SpeedCmdIq / 256;
    }

#endif

}

//position loop P adjust
void PositionLoopP(PositionLoopTypedef* pPosLp, FeedbackTypedef* pFbk, INT32U OutLimit)
{
    INT32U temp32u;
    INT32S temp32s;
    temp32s = (pPosLp->CmdPosAct - pFbk->PosAbs);
    pPosLp->FollowErr = temp32s;
    if(pPosLp->Kpp != 0)
    {
        temp32u = OutLimit/pPosLp->Kpp;
        if(temp32s >= (INT32S)temp32u)
        {
            pPosLp->OutCmdSpeed = (INT32S)OutLimit;
        }
        else if(temp32s <= (INT32S)(-temp32u))
        {
            pPosLp->OutCmdSpeed = (INT32S)(-OutLimit);
        }
        else
        {
            pPosLp->OutCmdSpeed = (INT32S)pPosLp->Kpp * temp32s;
        }

        //Follow error alarm
        if(pPosLp->FollowErr < 0)
            temp32s = -(pPosLp->FollowErr);
        else
            temp32s = (pPosLp->FollowErr);
        if(temp32s > pPosLp->MaxFollowErr)
            pPosLp->FollowErrMsg = 1;
        else
            pPosLp->FollowErrMsg = 0;
    }
    else
    {
        pPosLp->OutCmdSpeed = 0;
    }
}

//calculate the IIt(DEC)
void CalIItDec(IItParameterTypedef* pIItPar, INT16S RealCurDec)
{
    INT32S temp32s;
    if(pIItPar->EnableFlag == 1)    //enable?
    {
    temp32s = (INT32S)RealCurDec * (INT32S)RealCurDec;
    //C(n) = C(n-1) + [R(n) - C(n-1)]/UserSetT_DEC;
    temp32s =pIItPar->RealIItDEC_R + temp32s - pIItPar->RealIItDEC_D;
    pIItPar->RealIItDEC_D = pIItPar->RealIItDEC_D + temp32s / (pIItPar->UserSetT_DEC);   //商数
    pIItPar->RealIItDEC_R = temp32s % (pIItPar->UserSetT_DEC);    //余数
    }
}

//read the first motor hall signal
INT8U ReadEncHall_1_State(void)
{
    BIT8_STRUCT_DEF hall_state;

    hall_state.All = 0;

    //hall_state.Bit.bit2 = _GET_ENC1_U_STATUS;
    //hall_state.Bit.bit1 = _GET_ENC1_V_STATUS;
    //hall_state.Bit.bit0 = _GET_ENC1_W_STATUS;

    return(hall_state.All);
}

//read the sencond motor hall signal
INT8U ReadEncHall_2_State(void)
{
    BIT8_STRUCT_DEF hall_state;

    hall_state.All = 0;

    //hall_state.Bit.bit2 = _GET_ENC2_U_STATUS;
    //hall_state.Bit.bit1 = _GET_ENC2_V_STATUS;
    //hall_state.Bit.bit0 = _GET_ENC2_W_STATUS;

    return(hall_state.All);
}
//get hall sensor offset
void GetHallOffset(FeedbackTypedef* pFbk, MotorParameterTypedef* pMotorPar)
{
    UNION_DATA_DEF  un_temp32;

    un_temp32.Int32u = (pMotorPar->FB_Resolution/pMotorPar->Poles)/12;
    //Enc_Hall.Bit.bit2 = _GET_ENC_U_STATUS;
    //Enc_Hall.Bit.bit1 = _GET_ENC_V_STATUS;
    //Enc_Hall.Bit.bit0 = _GET_ENC_W_STATUS;
    pFbk->ENC_Hall.All = (pFbk->pF_R_Hall)();

    if(pFbk->ENC_Hall.All == 0x05)    //0~60
        pFbk->HallOffet = un_temp32.Int32u * 11;
    if(pFbk->ENC_Hall.All == 0x04)    //60~120
        pFbk->HallOffet = un_temp32.Int32u * 9;
    if(pFbk->ENC_Hall.All == 0x06)    //120~180
        pFbk->HallOffet = un_temp32.Int32u * 7;
    if(pFbk->ENC_Hall.All == 0x02)    //180~240
        pFbk->HallOffet = un_temp32.Int32u * 5;
    if(pFbk->ENC_Hall.All == 0x03)    //240~300
        pFbk->HallOffet = un_temp32.Int32u * 3;
    if(pFbk->ENC_Hall.All == 0x01)    //300~360
        pFbk->HallOffet = un_temp32.Int32u * 1;
}

//limited the max speed
void LimitedMaxSpeed(SpeedLoopTypedef* pSpdLp)
{
    if(pSpdLp->CmdSpeedDecAct > pSpdLp->CmdSpeedMaxDec)
        pSpdLp->CmdSpeedDecAct = pSpdLp->CmdSpeedMaxDec;
    else if(pSpdLp->CmdSpeedDecAct < -(pSpdLp->CmdSpeedMaxDec))
    {
        pSpdLp->CmdSpeedDecAct = -(pSpdLp->CmdSpeedMaxDec);
    }
}
//quick stop
void QuiekStop(DriverStructTypedef* pDX)
{
    pDX->GbFlg.QkStopAct = pDX->GbFlg.QkStopCmd | pDX->GbFlg.QkStopDin;
    if(pDX->GbFlg.QkStopAct != 0)
    {
        if(pDX->GbFlg.QkStopMode == 1)
        {
            pDX->PosLp.ProfileDeceAct = pDX->PosLp.QkStopDeceAct;
            pDX->SpdLp.CmdSpeedDec = 0;
            pDX->PosLp.OutCmdSpeed = 0; //clear the position loop output speed cmd
        }
        else
        {
            pDX->PosLp.ProfileDeceAct = 1073600;    //1000rps/s
            pDX->SpdLp.CmdSpeedDec = 0;
        }
    }
    else
    {
        pDX->PosLp.ProfileAcceAct = pDX->PosLp.ProfileAcceCmd;
        pDX->PosLp.ProfileDeceAct = pDX->PosLp.ProfileDeceCmd;
        pDX->SpdLp.CmdSpeedDec = pDX->SpdLp.CmdCmdSpeedDec;
    }
}

//clear position loop PI value
void ClrPosLoopPI(PositionLoopTypedef* pPosLp)
{
    pPosLp->OutCmdSpeed = 0;
}

//clear speed loop PI value
void ClrSpeedLoopPI(SpeedLoopTypedef* pSpdLp)
{
    pSpdLp->SpeedKiFltSum = 0;
    pSpdLp->SpeedKpiFltSum = 0;
    pSpdLp->SpeedKiFltSum32 = 0;
    pSpdLp->DeltaSpeedLastDec = 0;
    pSpdLp->SpeedKiSum = 0;
    pSpdLp->SpeedKi32Sum = 0;
    pSpdLp->SpeedKiSumOut = 0;
    pSpdLp->SpeedKp = 0;
    pSpdLp->SpeedCmdIq = 0;
    pSpdLp->OutCmdIq = 0;
    pSpdLp->OutCmdIqLast = 0;
    pSpdLp->CmdSpeedDecAct = 0;
    pSpdLp->CmdSpeedDecCal = 0;
    pSpdLp->CmdSpeedDecExt = 0;
    pSpdLp->SpeedKiSum32 = 0;
}

//clear current loop PI value
void ClrCurrLoopPI(CurrLoopTypedef* pCurLp)
{
    pCurLp->CmdIqAct = 0;
    pCurLp->CmdIdAct = 0;
    pCurLp->DeltaIqLast = 0;
    pCurLp->DeltaIdLast = 0;
    pCurLp->VqKiSum = 0;
    pCurLp->VdKiSum = 0;
    pCurLp->VqLast = 0;
    pCurLp->VdLast = 0;
    pCurLp->Vq = 0;
    pCurLp->Vd = 0;
    pCurLp->VqOut = 0;
    pCurLp->VdOut = 0;
    pCurLp->CmdIqFlt = 0;
}

//get the motor temperature data
void GetMotorTemperature(DriverStructTypedef* pDX)
{
    UNION_DATA_DEF  un_temp32;
    un_temp32.Int32s = 0;
    un_temp32.Int8s = *(pDX->MotorPar.pTemp);
    pDX->MotorPar.Temp = (INT16S)un_temp32.Int8s;
}

//Iq peak hild
void RealIqPeakHold(DriverStructTypedef* pDX)
{
    if(pDX->CurLp.RealIqPk < pDX->Park.Iq)
        pDX->CurLp.RealIqPk = pDX->Park.Iq;
}

void ExcitationFaultProcess(DriverStructTypedef* pDX)
{
    (pDX->pF_DriverOff)();
    pDX->GbFlg.Excitation = 0;
    pDX->GbFlg.CtrlWord = 6;
    pDX->GbFlg.CtrlWordAct = 4;
    pDX->GbFlg.ErrState1 |= FIND_MOTOR_ERR_CODE;
    pDX->GbFlg.ExciCnt = 0;
}
//driver 1 on / off
void Driver1_On(void)
{
    _DRIVE1_ON;
}
void Driver1_Off(void)
{
    _DRIVE1_OFF;
    TIM1->CCR1 = PWM_PERIOD/2;
    TIM1->CCR2 = PWM_PERIOD/2;
    TIM1->CCR3 = PWM_PERIOD/2;
}
//driver 2 on / off
void Driver2_On(void)
{
    _DRIVE2_ON;
}
void Driver2_Off(void)
{
    _DRIVE2_OFF;
    TIM8->CCR1 = PWM_PERIOD/2;
    TIM8->CCR2 = PWM_PERIOD/2;
    TIM8->CCR3 = PWM_PERIOD/2;
}

//driver enc 1 power on / off
void Enc1_PowerOn(void)
{
    _ENC1_POWER_ON;
    DX[D1].Fbk.EncPwOnInitFlag = 1;
}
void Enc1_PowerOff(void)
{
    _ENC1_POWER_OFF;
}

//driver enc 2 power on / off
void Enc2_PowerOn(void)
{
    _ENC2_POWER_ON;
    DX[D2].Fbk.EncPwOnInitFlag = 1;
}
void Enc2_PowerOff(void)
{
    _ENC2_POWER_OFF;
}

//driver 1 error led display
void Driver1_ErrLedOn(void)
{
    _DR1_ERR_LED_ON;
}
void Driver1_ErrLedOff(void)
{
    _DR1_ERR_LED_OFF;
}
//driver 2 error led display
void Driver2_ErrLedOn(void)
{
    _DR2_ERR_LED_ON;
}
void Driver2_ErrLedOff(void)
{
    _DR2_ERR_LED_OFF;
}

//dc motor on / off
void DC_MotorOn(void)
{
    TIM_SetCounter(TIM9, DM_PWM_PERIOD/2);
    TIM_Cmd(TIM9, ENABLE);

}
void DC_MotorOff(void)
{
    TIM9->CCR1 = DM_PWM_PERIOD/2;
    TIM9->CCR2 = DM_PWM_PERIOD/2;
    TIM_Cmd(TIM9, DISABLE);
    TIM_SetCounter(TIM9, DM_PWM_PERIOD/2);
}

void LowPass1FilterProcess(AnalogProcessTypedef* pAi)
{
    UNION32_DATA_DEF temp32;

    if(pAi->Lp1f.Enable)
    {
        pAi->Lp1f.Rn = *(pAi->AiBase.pAdcOrg);
        temp32.Int32u = (65536 - pAi->Lp1f.CfftA) * (INT32U)(pAi->Lp1f.Rn)\
                        + (pAi->Lp1f.CfftA) * (INT32U)(pAi->Lp1f.Cn)\
                        + pAi->Lp1f.CnRemain;
        pAi->Lp1f.Cn = temp32.Split.High16u;
        pAi->Lp1f.CnRemain =  temp32.Split.Low16u;

        pAi->AiBase.AdcOrg = pAi->Lp1f.Cn;
    }
    else
    {
        pAi->AiBase.AdcOrg = *(pAi->AiBase.pAdcOrg);
    }

    CalAnalogRealDec(&pAi->AiBase);
}
